USE [corporerm]
GO

/****** Object:  UserDefinedFunction [dbo].[Fluig_Colaboradores]    Script Date: 06/05/2021 09:57:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




/* funcao retorna os colaboradores que estão vinculados as seções que possuem o mesmo chefe do centro de custo relacionado no processo. */

CREATE FUNCTION [dbo].[Fluig_Colaboradores]  

( @CENTROCUSTO AS VARCHAR(17)) 

RETURNS @result TABLE (colaborador varchar(120), codusuario varchar(20))
AS
BEGIN

IF ((SELECT COUNT(*)
			FROM PFUNC 
				JOIN PPESSOA ON (PFUNC.CODPESSOA=PPESSOA.CODIGO)
			WHERE	CODSITUACAO <> 'D'
			AND		PPESSOA.CODUSUARIO IS NOT NULL
			AND		CODSECAO IN ( 	SELECT CODSECAO /* EM QUAIS SEÇÕES ELE É CHEFE? */
										FROM PSUBSTCHEFE 
									WHERE CHAPASUBST IN (SELECT CHAPASUBST /* CHEFE DO CENTRO DE CUSTO INFORMADO */
																FROM PSUBSTCHEFE
																JOIN PSECAO ON (PSUBSTCHEFE.CODSECAO=PSECAO.CODIGO)
															WHERE	PSECAO.NROCENCUSTOCONT LIKE substring(@CENTROCUSTO,0,13)+'%')))=0)

		insert into @result 
		SELECT DISTINCT PPESSOA.NOME COLABORADOR, LOWER(PPESSOA.CODUSUARIO) CODUSUARIO
				FROM PFUNC 
					JOIN PPESSOA ON (PFUNC.CODPESSOA=PPESSOA.CODIGO)
				WHERE	CODSITUACAO <> 'D'
				AND		PPESSOA.CODUSUARIO IS NOT NULL


ELSE IF 	 ((SELECT  COUNT(*) /* EFETUANDO CONTAGEM PARA VERIFICAR SE ESTA VAZIO */
				FROM PFUNC 
					JOIN PPESSOA ON (PFUNC.CODPESSOA=PPESSOA.CODIGO)
				WHERE	CODSITUACAO <> 'D'
				AND		PPESSOA.CODUSUARIO IS NOT NULL
				AND		CODSECAO IN ( 	SELECT CODSECAO /* EM QUAIS SEÇÕES ELE É CHEFE? */
											FROM PSUBSTCHEFE 
										WHERE CHAPASUBST IN (	SELECT CHAPASUBST /* CHEFE DO CENTRO DE CUSTO INFORMADO */
																	FROM PSUBSTCHEFE
																	JOIN PSECAO ON (PSUBSTCHEFE.CODSECAO=PSECAO.CODIGO)
																WHERE	PSECAO.NROCENCUSTOCONT = @CENTROCUSTO))) = 0)


		insert into @result 
		SELECT DISTINCT PPESSOA.NOME COLABORADOR, LOWER(PPESSOA.CODUSUARIO) CODUSUARIO
				FROM PFUNC 
					JOIN PPESSOA ON (PFUNC.CODPESSOA=PPESSOA.CODIGO)
				WHERE	CODSITUACAO <> 'D'
				AND		PPESSOA.CODUSUARIO IS NOT NULL
				AND		CODSECAO IN ( 	SELECT CODSECAO /* EM QUAIS SEÇÕES ELE É CHEFE? */
											FROM PSUBSTCHEFE 
										WHERE CHAPASUBST IN (SELECT CHAPASUBST /* CHEFE DO CENTRO DE CUSTO INFORMADO */
																	FROM PSUBSTCHEFE
																	JOIN PSECAO ON (PSUBSTCHEFE.CODSECAO=PSECAO.CODIGO)
																WHERE	PSECAO.NROCENCUSTOCONT LIKE substring(@CENTROCUSTO,0,13)+'%'))

ELSE

		insert into @result 
		SELECT DISTINCT PPESSOA.NOME COLABORADOR, LOWER(PPESSOA.CODUSUARIO) CODUSUARIO
				FROM PFUNC 
					JOIN PPESSOA ON (PFUNC.CODPESSOA=PPESSOA.CODIGO)
				WHERE	CODSITUACAO <> 'D'
				AND		PPESSOA.CODUSUARIO IS NOT NULL
				AND		CODSECAO IN ( 	SELECT CODSECAO /* EM QUAIS SEÇÕES ELE É CHEFE? */
											FROM PSUBSTCHEFE 
										WHERE CHAPASUBST IN (	SELECT CHAPASUBST /* CHEFE DO CENTRO DE CUSTO INFORMADO */
																	FROM PSUBSTCHEFE
																	JOIN PSECAO ON (PSUBSTCHEFE.CODSECAO=PSECAO.CODIGO)
																WHERE	PSECAO.NROCENCUSTOCONT = @CENTROCUSTO))

	return;																

END

    

GO


